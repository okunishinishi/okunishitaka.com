/**
 * Bud file for entity test.
 */

"use strict";

var u = require('apeman-util'),
    fs = u.core.fs,
    filtering = u.filtering,
    string = u.string,
    mapping = u.mapping,
    reducing = u.reducing,
    path = u.core.path;

var basedir = path.resolve(__dirname, '../../../..'),
    srcDir = path.resolve(basedir, 'public/javascripts/ok/directives'),
    destDir = __dirname;

function entityTestBud(srcDir, destDir) {
    return fs.readdirSync(srcDir)
        .filter(filtering.patternAcceptFilter(/\.js$/))
        .filter(filtering.patternRejectFilter(/^_/))
        .filter(filtering.patternRejectFilter(/^\./))
        .map(mapping.pathResolveMap(srcDir))
        .map(function (src) {
            var name = path.basename(src, path.extname(src)).replace(/\$/, '');
            return {
                force: false,
                mode: '644',
                path: path.resolve(destDir, name + '-test.js'),
                data: {
                    prefix: 'ok',
                    name: string.camelString(name),
                    attr: string.paramString(name).split(/\-/g).reduce(function (result, cur, i) {
                        if (!result) {
                            return cur;
                        }
                        if (i == 1) {
                            return [result, cur].join(':');
                        }
                        return [result, cur].join('-');
                    }, ''),
                    Name: string.pascalString(name)
                }
            }
        });
}


module.exports = [
    entityTestBud(path.resolve(srcDir), destDir)
].reduce(reducing.concatReduce(), []);
